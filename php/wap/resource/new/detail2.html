<!DOCTYPE html>
<html id="html">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Cache-control" content="no-cache">
<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
<link rel="stylesheet" href="css/base.css" type="text/css" />
<link rel="stylesheet" href="css/detail2.css" type="text/css" />
<title class="seoTitle"></title>
</head>
<body>
<script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
<script src="http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion=403159"></script>
<script type="text/javascript" src="http://api.map.baidu.com/api?type=quick&amp;v=2.0&amp;ak=C9mkSR7qE9aiyguAAk1Q0ttY"></script>
<script type="text/javascript" src="http://api.map.baidu.com/getscript?type=quick&amp;file=api&amp;ak=C9mkSR7qE9aiyguAAk1Q0ttY&amp;t=20140109092002"></script>
<script type="text/javascript" src="http://api.map.baidu.com/getscript?type=quick&amp;file=feature&amp;ak=C9mkSR7qE9aiyguAAk1Q0ttY&amp;t=20140109092002"></script>

<content class="jsLoad hide">
	<div class="cover-page"></div>
	<div class="leavebox hide">
		<div class="tit">请输入您的留言</div>
		<textarea></textarea>
		<div class="admin"><a class="cancel">取消</a><a class="submit">推荐一票</a></div>
	</div>
	<div class="send2">
		<a class="click" htm="http://mp.weixin.qq.com/s?__biz=MjM5OTM3OTQ2MQ==&mid=505850917&idx=1&sn=f0e1885190896367080c822a73d158e4#rd" target="_blank"><p class="one">
			<img src="img/detail/bottom/follow_off.png" /> <br />关注
		</p></a>
		<p class="two">
			<a class="line" id="vote"><img src="img/detail/bottom/recommend.png" /> 推荐一票</a>
			<a class="line click" id="onlinec"><img src="img/detail/bottom/consulting.png" /> 在线咨询</a>
			<a id="phonec"><img src="img/detail/bottom/phone.png" /> 电话咨询</a>
		</p>
	</div>
	<div class="head">
		<a href="index.html"><img src="img/other/back.png" /></a> 我的名片
	</div>
	<section class="one">
		<div class="pic"><img id="logo" src="" /></div>
		<div class="tit"><img id="is_vip" class="hide" src="img/detail/vip.png" /><span id="title">...</span></div>
		<div class="data">
			<div class="imgtext mobile"><img src="img/detail/mobile.png" /> <b style="color:#DF4B24" id="phone">...</b></div>
			<div class="imgtext location"><img src="img/detail/location.png" /> <span class="csr" id="address">...</span></div>
			<div class="explain"><span>浏览量：</span><span class="red" id="view">...</span><span class="right">发布时间：<span class="red" id="ctime">...</span></span></div>
			<!--<div class="explain"><b id="hot">...</b>推荐 <b id="view">...</b>浏览</div>-->
		</div>
		<!--<div class="card">
			<p class="flt"><a onClick="recommend()">推荐置顶 <span>◎</span></a></p>
			<p class="frt"><a onclick="goToAddress()">一键导航 <span>◎</span></a></p>
			<br class="cb"/>
		</div>-->
		<div class="bdsharebuttonbox" id='bdsharebuttonbox'>
			<a class="bds_more flt" data-cmd="more">分享：</a>
			<a class="bds_tqq frt" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
			<a class="bds_sqq frt" data-cmd="sqq" title="分享到QQ好友">QQ好友</a>
			<a class="bds_tsina frt" data-cmd="tsina" title="分享到新浪微博">微博</a>
			<a class="bds_qzone frt" data-cmd="qzone" title="分享到QQ空间">空间</a>
			<br class="cb"/>
		</div>
	</section>
	<section class="level">
		<div class="tit" id="leave">
			推荐指数					
			<span class="star" id="stars">
				<img src="img/other/star_off.png" /><img src="img/other/star_off.png" /><img src="img/other/star_off.png" /><img src="img/other/star_off.png" /><img src="img/other/star_off.png" />
			</span> <span class="viewer">支持者<span id="viewNum">0</span>票</span>
		</div>
		<dl class="dtail" id="dtail">
		</dl>
		<div class="views" id="views">↓ 查看更多支持者</div>
		<div class="views hide" id="viewsClose">↑ 收回<span></div>
	</section>
	<section class="two" style="display:none" id="sgoods">
		<div class="tit"><b>车货信息</b></div>
		<div class="data">
			<div class="from">
				<img class="one" src="img/detail/from.png" />杭州 滨江<img class="two" src="img/detail/to.png" /><img class="three" src="img/detail/area.png" />北京 三里屯
			</div>
			<div class="company">杭州行风物流有限公司</div>
		</div>
		<dl class="card">
			<dt>货品信息  &nbsp;&nbsp;配件 36吨 25方</dt>
			<dt>所需车辆  &nbsp;&nbsp;需13米高栏车</dt>
			<dt>装货时间  &nbsp;&nbsp;今日下午<span>12:00</span>发货</dt>
			<dt>备注信息  &nbsp;&nbsp;货物需要直达，希望中途不要停车</dt>
		</dl>
	</section>
	<section class="three">
		<div class="tit"><b>名片详情</b></div>
		<div class="contents" id="contents">
		</div>
	</section>
	<section class="four">
		<div class="tit"><b>我的二维码</b></div>
		<div class="qrcode">
			<div id="qrcode"></div> <!-- src="img/my/qrcode.png"-->
			<div class="text">（长按图片保存）</div>
		</div>
	</section>
<div class="foot-tserver">
	<p>Copyright © 2016 查物流 浙ICP备14004390号</p>
	<p>全国统一客服热线 <a style="color:#0066CC" href="tel:400-800-7756">400-800-7756</a>
</p>
</div>
<div class="foot-tserver2">
	<p>&nbsp;</p>
</div>
</content>
<img src="" id="logo_share" class="hide"/>
<script src="js/base2.js"></script>
<script src="js/jquery.cookie.js"></script>
<script src="js/qrcode.js"></script>
<script>
getUser(function(){
	$('.click').click(function(){
		if(_userInfo) location.href = $(this).attr('htm');
		else _followFunc();
	})
	var _hotClick = function(id){
		if(!id) return false;
		$.ajax({
			url : "http://wap.chawuliu.com/hot",
			data : {id:id},
			success : function(res){
				res = $.parseJSON(res);
				if( res.status == 'y'){
					var count = $(".hot_count").html();
					count = parseInt(count);
					$(".hot_count").html( count+1 );
					alert( res.info );
				}else{
					if( res.info  != '对不起，该会员未通过VIP认证，不能推荐！' ){
						alert( res.info );

					}
				}
			}
		})
	}
	//微信初始化
	var initWX = function(dd){
		$.ajax({
			url: '/wechat/sign',
			data: {
				url: encodeURIComponent(location.href.split('#')[0])
			},
			success: function(data){
				var ticket = JSON.parse(data);

				wx && wx.config({
					debug: false,
					appId: ticket.appId,
					timestamp: ticket.timestamp,
					nonceStr: ticket.nonceStr,
					signature: ticket.signature,
					jsApiList: [
						'onMenuShareAppMessage',
						'onMenuShareTimeline'
					]
				});
				wx && wx.ready(function(){
					wx.onMenuShareAppMessage({
						title: dd.page.title, // 分享标题
						desc: '', // 分享描述
						link: '', // 分享链接
						imgUrl: dd.page.logo, // 分享图标
						type: '', // 分享类型,music、video或link，不填默认为link
						dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
						success: function () {
							// 用户确认分享后执行的回调函数
						},
						cancel: function () {
							// 用户取消分享后执行的回调函数
						}
					});
					wx.onMenuShareTimeline({
						title: dd.page.title, // 分享标题
						link: '', // 分享链接
						imgUrl: dd.page.logo, // 分享图标
						success: function () {
							// 用户确认分享后执行的回调函数
						},
						cancel: function () {
							// 用户取消分享后执行的回调函数
						}
					});
				});
				wx && wx.error(function(res){
					//alert(str(res));
				});
			}
		})
	};
	var did = Base.tools.getQueryString('id'),
		uid = Base.tools.getQueryString('uid'),
		lboxArea = $('.leavebox textarea'),
		cover = $('.cover-page'),
		viewsPage = 0,
		lboxShow = function(){
			$('.leavebox').removeClass('hide');
			cover.show();
			$('.send2').hide();
			lboxArea[0].focus();
		},
		lboxHide = function(){
			$('.leavebox').addClass('hide');
			cover.hide();
			$('.send2').show();
			$('.leavebox textarea').val('')
		},
		dtailDom = '\
			<dt>\
				<div class="flt heads">\
					<img id="logo1" src="#headimgurl" />\
				</div>\
				<div class="frt txt">\
					<div class="up">#nickname <span>#ctime</span></div>\
					<div class="down">#message</div>\
				</div>\
				<br class="cb"/>\
			</dt>\
		',
		getData = function(get){
			$.ajax({
				url: '/detail2/'+did,
				dataType: 'json',
				success : function(dd) {
					if(!get){
						$('#title').text(dd.page.title);
						if(dd.page.is_vip=='1') $('#is_vip').show();
						else $('#is_vip').hide();
						$('#phone').text(dd.page.phone);
						$('#hot').text(dd.page.hot);
						$('#view').text(dd.page.view);
						$('#address').text(dd.page.address);
						$('#logo').attr('src',dd.page.logo);
						$('#logo_share').attr('src',dd.page.logo);
						$('#onlinec').attr('htm','mdetail.html?id='+uid);
						$('#phonec').attr('href','tel:'+dd.page.phone);
						$('#ctime').text(Base.tools.int_to_str(dd.page.ctime));
						$('.seoTitle').text(dd.page.title);
						initWX(dd);
						(function(){
							var qrcode = new QRCode(document.getElementById("qrcode"), {
								width : 300,//设置宽高
								height : 300
							});
							qrcode.makeCode(location.href); //location.protocol + "//" + location.host + "/lottery/pos.html?id=" + did
						})();
						var cnt = dd.page.content,
							tmp = '<p style="color:#FF8500;line-height:22px">#insert</p>';
						if(dd.page.isMember>0){
							$('#viplogo').show();
							cnt += tmp.replace('#insert',dd.tip4);
						}
						$('#contents').html(cnt);
					}
					//留言
					var mc = dd.message_count,
						msgs = dd.messages;
					$('#viewNum').text(mc);
					$('#dtail').html(function(){
						var htm = '',
							tmp = dtailDom;
						for(var k in msgs) {
							var m = msgs[k];
							htm += tmp.replace('#message',m.message).replace('#ctime',Base.tools.int_to_str(m.ctime)).replace('#headimgurl',m.user_info[0].headimgurl).replace('#nickname',m.user_info[0].nickname);
						}
						return htm;
					});
					$('#dtail>dt:gt(0)').hide();
					$('#stars').html(getStar(mc));
					$('.jsLoad').removeClass('hide');
				},
				error:function(jqXHR,textStatus) {
					log(' request failed'+textStatus);
				}
			});
		}
	;
	getData();
	
	$('#views').click(function(){
		viewsPage+=5;
		$('#dtail>dt:lt('+viewsPage+')').show();
		if(viewsPage>=$('#dtail>dt').length) $(this).hide();
		$('#viewsClose').show();
	})
	$('#viewsClose').click(function(){
		$('#dtail>dt:gt(0)').hide();
		viewsPage = 0;
		$('#views').show();
		$(this).hide();
	})
	$('#vote').click(function(){
		if(_userInfo) {
			if($('.leavebox').hasClass('hide')) lboxShow();
			else lboxHide();
		}
		else _followFunc();
	})
	$('#leave').click(function(){
		if(_userInfo) {
			if($('.leavebox').hasClass('hide')) lboxShow();
			else lboxHide();
		}
		else _followFunc();
	})
	$('.leavebox a.cancel').click(function(){
		lboxHide();
	})
	$('.leavebox a.submit').click(function(){
		var val  = $('.leavebox textarea').val();
		if(val){
			lboxHide();
			$.ajax({
				url: '/page/support',
				data: {page_id:did},
				dataType: 'json',
				success : function(dd) {
					if(dd.info=='不能重复支持'){
						alert('亲，您已经推荐过了！');
						getData(1);
					}
					else{
						$.ajax({
							url: '/page/message',
							data: {page_id: did, message: val},
							dataType: 'json',
							success : function() {
								getData(1);
								_hotClick(did);
							}
						})
					}
				}
			})
		}
	})
	
	$('#address').click(function(){
		var myGeo = new BMap.Geocoder(),
			title = $('#title').text(),
			address = $('#address').text()
			;
		// 将地址解析结果显示在地图上,并调整地图视野
		myGeo.getPoint(address, function(point){
		  if (point) {
		   var lng=point.lng;
			var lat=point.lat;
			var url="http://api.map.baidu.com/marker?location="+lat+","+lng+"&title="+title+"&content="+address+"&output=html&appName=查物流";
			}else{
			var url="http://api.map.baidu.com/geocoder?address="+address+"&output=html";
			}
		window.location.href=url;
		}, "");
	});
})
</script>
</body>
</html>